<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nimbus RBAC Demo - HTML Edition</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure a custom font and ensure dark mode is off -->
    <script>
        tailwind.config = {
            // Enable dark mode using the 'class' strategy
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Use a simple font import -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body class="font-sans bg-gray-50 min-h-screen dark:bg-gray-900">
    <!-- Main App Container -->
    <div id="app-root">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex justify-center items-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-t-4 border-indigo-500"></div>
        </div>
    </div>

    <script type="module">
        // Import Lucide-like icons as inline SVG strings
        const ICONS = {
            LogIn: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>',
            User: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            Edit: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
            Plus: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',
            Users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            Shield: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>',
            Refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 22v-6h-6"/><path d="M21 16a9 9 0 0 0-9-9 9 9 0 0 0-9 9v1a10 10 0 0 1-1.3-4.3c-.7-2.7 1-5.6 3.7-6.4 2.7-.7 5.6 1 6.4 3.7"/></svg>',
            // Icons for Theme Toggle
            Sun: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
            Moon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',
        };

        const API_BASE_URL = 'http://localhost:3001/api';
        const APP_ROOT = document.getElementById('app-root');

        // --- Global State ---
        let user = null;
        let posts = [];
        let currentView = 'dashboard';
        let isLoading = false;
        let authMessage = ''; // Used for login/register errors
        let generalMessage = ''; // Used for dashboard/admin messages
        let currentTheme = 'light'; // State for theme

        // --- RBAC Permission Matrix ---
        const PERMISSIONS = {
            ADMIN: {
                'users': ['create', 'read', 'update', 'delete'],
                'posts': ['create', 'read', 'update', 'delete'],
                'admin': ['manage_roles']
            },
            EDITOR: {
                'posts': ['create', 'read'],
                'self_posts': ['update', 'delete'], // Can update/delete only their own posts
                'users': ['read']
            },
            VIEWER: {
                'posts': ['read']
            }
        };

        const ROLE_COLORS = {
            ADMIN: 'text-red-700 bg-red-100 border-red-300 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700',
            EDITOR: 'text-green-700 bg-green-100 border-green-300 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700',
            VIEWER: 'text-blue-700 bg-blue-100 border-blue-300 dark:bg-blue-900/50 dark:text-blue-300 dark:border-blue-700',
        };

        // --- Core Functions ---

        /** Checks if the current user has permission for an action/resource. */
        function can(resource, action, itemAuthorId = null) {
            if (!user || !user.role) return false;

            const rolePermissions = PERMISSIONS[user.role];
            if (!rolePermissions) return false;

            // 1. Standard Permission Check
            if (rolePermissions[resource] && rolePermissions[resource].includes(action)) {
                return true;
            }

            // 2. Ownership Check
            if (itemAuthorId !== null) {
                const selfResource = `self_${resource}`;
                if (rolePermissions[selfResource] && rolePermissions[selfResource].includes(action)) {
                    return user.userId === itemAuthorId;
                }
            }
            return false;
        }

        function loadUser() {
            const storedUser = localStorage.getItem('rbacUser');
            if (storedUser) {
                user = JSON.parse(storedUser);
            }
        }

        function login(userData) {
            user = userData;
            localStorage.setItem('rbacUser', JSON.stringify(userData));
            authMessage = '';
            initApp();
        }

        function logout() {
            user = null;
            localStorage.removeItem('rbacUser');
            currentView = 'dashboard';
            initApp();
        }
        
        // --- Theme Functions ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            currentTheme = theme;
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('rbacTheme', newTheme);
            renderApp(); // Re-render to update the icon
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('rbacTheme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // Default to system preference if no theme is saved
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        }

        // --- View Renderers ---

        function renderSpinner() {
            APP_ROOT.innerHTML = `
                <div class="flex justify-center items-center h-screen">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-t-4 border-indigo-500"></div>
                </div>
            `;
        }

        function renderHeader() {
            const navItems = [
                { name: 'Dashboard', view: 'dashboard', requiresAuth: true, show: true },
                { name: 'Admin Panel', view: 'admin', requiresAuth: true, show: user && can('users', 'read') },
            ];

            const navHtml = navItems.filter(i => i.show !== false).map(item => `
                <button
                    onclick="setCurrentView('${item.view}')"
                    class="px-4 py-2 text-md font-bold rounded-xl transition duration-150 shadow-md ${
                        currentView === item.view
                            ? 'bg-blue-600 text-white shadow-blue-300'
                            : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white'
                    }"
                >
                    ${item.name}
                </button>
            `).join('');

            const authSection = user ? `
                <div class="flex items-center space-x-4">
                    <div class="px-4 py-2 text-sm font-bold rounded-full border shadow-sm ${ROLE_COLORS[user.role]}">
                        Role: ${user.role}
                    </div>
                    <button
                        onclick="logout()"
                        class="py-2 px-4 border border-transparent rounded-xl text-md font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg shadow-red-300"
                    >
                        <span class="w-4 h-4 inline-block align-middle mr-1">${ICONS.LogIn}</span> Logout
                    </button>
                </div>
            ` : `
                <span class="text-md font-medium text-gray-500 dark:text-gray-400">Not Logged In</span>
            `;

            return `
                <header class="bg-white shadow-lg sticky top-0 z-10 border-b border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-20">
                            <div class="flex-shrink-0 text-3xl font-extrabold text-blue-700 dark:text-blue-400">
                                Nimbus <span class='text-gray-500 dark:text-gray-400'>RBAC Demo</span>
                            </div>
                            <nav class="flex items-center space-x-6">
                                ${user ? navHtml : ''}
                            </nav>
                            ${authSection}
                        </div>
                    </div>
                </header>
            `;
        }

        function renderUserCard() {
            if (!user) return '';

            return `
                <div class="p-5 rounded-xl shadow-lg mt-8 mb-8 flex items-center justify-between border ${ROLE_COLORS[user.role]}">
                    <div class='flex items-center'>
                        <span class='w-6 h-6 mr-3'>${ICONS.User}</span>
                        <div>
                            <h3 class="font-semibold text-2xl">
                                Welcome, ${user.username}
                            </h3>
                            <p class="text-sm font-medium opacity-80">
                                Role: <strong>${user.role}</strong> | User ID: ${user.userId}
                            </p>
                        </div>
                    </div>
                    <div class='text-xs font-mono opacity-80'>
                        TOKEN: ${user.token.substring(0, 10)}...
                    </div>
                </div>
            `;
        }

        function renderAuthView(isRegister = false) {
            const themeIcon = currentTheme === 'light' ? ICONS.Moon : ICONS.Sun;

            let viewHtml = `
                <div class="max-w-xl mx-auto p-10 mt-10 bg-white shadow-2xl rounded-3xl border border-gray-100 text-gray-800 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 relative">
                    
                    <!-- Theme Toggle Button -->
                    <button
                        onclick="toggleTheme()"
                        class="absolute top-6 right-6 p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition"
                        title="Toggle light/dark mode"
                    >
                        <span class="w-6 h-6">${themeIcon}</span>
                    </button>

                    <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">
                        <span class='w-8 h-8 inline-block mr-2 text-blue-600 dark:text-blue-400 align-text-top'>${ICONS.LogIn}</span> ${isRegister ? 'New Account Registration' : 'Sign In'}
                    </h2>
                    <p class="text-sm text-center mb-8 text-gray-600 bg-gray-50 p-3 rounded-xl border border-dashed dark:bg-gray-700 dark:text-gray-400 dark:border-gray-600">
                        <strong>Test Credentials:</strong> <span class='font-mono font-bold text-gray-700 dark:text-gray-300'>admin/admin123</span>, <span class='font-mono font-bold text-gray-700 dark:text-gray-300'>editor1/editor123</span>, <span class='font-mono font-bold text-gray-700 dark:text-gray-300'>viewer/viewer123</span>.
                    </p>
                    <form id="authForm" onsubmit="handleAuthSubmit(event, ${isRegister})">
                        <div class="space-y-6">
                            <div>
                                <input id="username" type="text" placeholder="Username" required
                                    class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 placeholder:text-gray-400 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:placeholder:text-gray-500"
                                >
                            </div>
                            <div>
                                <input id="password" type="password" placeholder="Password" required
                                    class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 placeholder:text-gray-400 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:placeholder:text-gray-500"
                                >
                            </div>

                            ${authMessage ? `<p class="text-red-500 text-sm p-3 bg-red-50 rounded-lg border border-red-200 dark:bg-red-900/50 dark:text-red-400 dark:border-red-700">${authMessage}</p>` : ''}

                            <button type="submit" id="authButton"
                                class="w-full flex justify-center py-3 px-4 rounded-xl shadow-lg text-lg font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
                            >
                                ${isRegister ? 'Register Account' : 'Login'}
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 text-center border-t pt-6 border-gray-100 dark:border-gray-700">
                        <button onclick="setCurrentView('auth', ${!isRegister})"
                            class="text-md font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition duration-150"
                        >
                            ${isRegister ? 'Already have an account? Sign In' : 'Need an account? Register Here'}
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = viewHtml;
        }

        async function handleAuthSubmit(e, isRegister) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const button = document.getElementById('authButton');

            button.disabled = true;
            button.innerHTML = 'Authenticating...';
            authMessage = ''; // Clear existing message

            const endpoint = isRegister ? 'register' : 'login';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || `Failed to ${endpoint}`);
                }

                login(data);

            } catch (err) {
                authMessage = err.message;
                renderApp(); // Re-render with error message
            } finally {
                if (document.getElementById('authButton')) { // Ensure button still exists
                    button.disabled = false;
                    button.innerHTML = isRegister ? 'Register Account' : 'Login';
                }
            }
        }

        // --- Dashboard & Post Logic ---

        function renderPostForm() {
            if (!user || !can('posts', 'create')) return '';

            return `
                <div class="p-8 bg-white rounded-2xl shadow-xl border border-gray-200 mb-10 text-gray-800 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200">
                    <h3 class="text-2xl font-bold mb-5 text-blue-700 dark:text-blue-400 flex items-center">
                        <span class='w-5 h-5 mr-2'>${ICONS.Plus}</span> Publish New Content
                    </h3>
                    <form id="postForm" onsubmit="handlePostCreate(event)" class="space-y-4">
                        <input id="postTitle" type="text" placeholder="Content Title" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                        />
                        <textarea id="postContent" placeholder="Content Body (Row-level ownership will be applied here)" rows="4" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                        ></textarea>
                        <button type="submit" id="createPostButton"
                            class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-150"
                        >
                            Publish Post
                        </button>
                    </form>
                    ${generalMessage && generalMessage.startsWith('✅ Post') ? `<p class="mt-4 text-sm font-medium p-3 rounded-lg bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700">${generalMessage}</p>` : ''}
                </div>
            `;
        }

        async function handlePostCreate(e) {
            e.preventDefault();
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const button = document.getElementById('createPostButton');

            button.disabled = true;
            button.innerHTML = 'Publishing...';
            generalMessage = '';

            try {
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${user.token}`
                    },
                    body: JSON.stringify({ title, content }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Post creation failed.');

                generalMessage = `✅ Post "${data.title}" created successfully!`;
                document.getElementById('postForm').reset();
                await fetchPosts();

            } catch (err) {
                generalMessage = `❌ Error: ${err.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Publish Post';
                renderApp(); // Rerender to show message
            }
        }

        function renderPostItem(post) {
            const isOwner = user && user.userId === post.authorId;
            const canUpdate = can('posts', 'update', post.authorId);
            const canDelete = can('posts', 'delete', post.authorId);

            const isActionAvailable = canUpdate || canDelete;

            // Simple view rendering (editing state will be handled by replacing this card)
            const actionButtons = isActionAvailable ? `
                <div class="flex space-x-2 shrink-0">
                    ${canUpdate ? `
                        <button onclick="handleEditStart('${post.id}')"
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-yellow-500 text-white hover:bg-yellow-600"
                            title="Edit Content"
                        >
                            <span class='w-4 h-4 mr-1'>${ICONS.Edit}</span> Edit
                        </button>
                    ` : `
                        <button disabled
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-yellow-300 text-white disabled:opacity-50 disabled:cursor-not-allowed"
                            title="Permission Denied: You cannot edit this content."
                        >
                            <span class='w-4 h-4 mr-1'>${ICONS.Edit}</span> Edit
                        </button>
                    `}
                    ${canDelete ? `
                        <button onclick="handlePostDelete('${post.id}')"
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-red-600 text-white hover:bg-red-700"
                            title="Delete Content"
                        >
                            <span class='w-4 h-4 mr-1'>${ICONS.Trash2}</span> Delete
                        </button>
                    ` : `
                        <button disabled
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-red-400 text-white disabled:opacity-50 disabled:cursor-not-allowed"
                            title="Permission Denied: You cannot delete this content."
                        >
                            <span class='w-4 h-4 mr-1'>${ICONS.Trash2}</span> Delete
                        </button>
                    `}
                </div>
            ` : '';

            return `
                <div id="post-${post.id}" class="p-6 rounded-2xl shadow-lg transition-shadow border text-gray-800 ${isOwner ? 'bg-indigo-50 border-indigo-200 hover:shadow-xl dark:bg-indigo-900/50 dark:border-indigo-700' : 'bg-white border-gray-200 hover:shadow-lg dark:bg-gray-800 dark:border-gray-700'}">
                    <div class='flex justify-between items-start'>
                        <div class='flex-1 pr-4'>
                            <h4 class="text-2xl font-extrabold text-gray-900 dark:text-white">${post.title}</h4>
                        </div>
                        ${actionButtons}
                    </div>

                    <p class="mt-3 text-gray-700 dark:text-gray-300">${post.content}</p>

                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full border ${isOwner ? 'bg-indigo-200 text-indigo-700 border-indigo-300 dark:bg-indigo-800 dark:text-indigo-200 dark:border-indigo-600' : 'bg-gray-100 text-gray-600 border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600'}">
                            ${isOwner ? 'YOUR CONTENT' : 'External Content'}
                        </span>
                        <span>
                            Author: <span class="font-medium text-gray-700 dark:text-gray-200">${post.author}</span> (ID: ${post.authorId})
                        </span>
                    </div>
                </div>
            `;
        }

        async function handlePostDelete(postId) {
            // Replaced confirm() with a simple true for non-interactive environments
            if (!(true)) return; // Was: if (!confirm(`...`))

            try {
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${user.token}` },
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Delete failed at API level.');
                }
                generalMessage = `✅ Post ${postId} deleted successfully.`;
                await fetchPosts();
            } catch (error) {
                generalMessage = `❌ Error deleting post: ${error.message}`;
            } finally {
                renderApp();
            }
        }

        function handleEditStart(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            const postElement = document.getElementById(`post-${postId}`);
            if (!postElement) return;

            // Render the editing form in place of the card
            postElement.innerHTML = `
                <form id="editForm-${postId}" onsubmit="handlePostUpdate(event, '${postId}')" class="space-y-4">
                    <input id="editTitle-${postId}" type="text" value="${post.title.replace(/"/g, '&quot;')}" required
                        class="w-full text-2xl font-bold p-2 border border-indigo-400 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 dark:bg-gray-700 dark:text-white dark:border-indigo-600"
                    />
                    <textarea id="editContent-${postId}" rows="4" required
                        class="w-full p-2 border border-indigo-300 rounded-lg text-gray-700 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                    >${post.content}</textarea>

                    <div class="flex justify-end space-x-2 border-t pt-4 border-gray-100 dark:border-gray-700">
                        <button type="submit" id="saveButton-${postId}"
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-indigo-600 text-white hover:bg-indigo-700"
                        >
                            <span class='w-4 h-4 mr-1'>${ICONS.Shield}</span> Save Changes
                        </button>
                        <button type="button" onclick="fetchPosts()"
                            class="flex items-center p-2 rounded-lg text-sm font-medium transition duration-150 shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500"
                        >
                            Cancel
                        </button>
                    </div>
                    <p id="editMessage-${postId}" class="text-sm text-red-500 dark:text-red-400"></p>
                </form>
            `;
        }

        async function handlePostUpdate(e, postId) {
            e.preventDefault();
            const title = document.getElementById(`editTitle-${postId}`).value;
            const content = document.getElementById(`editContent-${postId}`).value;
            const button = document.getElementById(`saveButton-${postId}`);
            const messageElement = document.getElementById(`editMessage-${postId}`);

            button.disabled = true;
            button.innerHTML = 'Saving...';
            messageElement.textContent = '';

            try {
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${user.token}`
                    },
                    body: JSON.stringify({ title, content }),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Update Failed');
                }
                generalMessage = `✅ Post ${postId} updated successfully.`;
                await fetchPosts();
            } catch (error) {
                messageElement.textContent = `❌ Error: ${error.message}`;
            } finally {
                // The card will be re-rendered, so no need to re-enable the button
                // But if the update failed, we need to re-render to show the main post card again
                if (messageElement.textContent) {
                    // Manually re-enable button if error occurred and we didn't re-fetch
                    button.disabled = false;
                    button.innerHTML = `<span class='w-4 h-4 mr-1'>${ICONS.Shield}</span> Save Changes`;
                } else {
                    renderApp(); // Re-render on success
                }
            }
        }

        async function fetchPosts() {
            isLoading = true;
            renderApp();
            generalMessage = '';

            try {
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${user.token}` },
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch posts.');
                }
                posts = data;
                generalMessage = ''; // Clear status message on success

            } catch (err) {
                posts = [];
                generalMessage = `❌ Error loading posts: ${err.message}. Check server or 'posts:read' permission.`;
            } finally {
                isLoading = false;
                renderApp();
            }
        }

        function renderDashboard() {
            let postsListHtml = '';
            if (!can('posts', 'read')) {
                postsListHtml = `
                    <div class="text-red-700 p-6 bg-red-100 rounded-xl border border-red-300 shadow-md dark:bg-red-900/50 dark:text-red-300 dark:border-red-700">
                        <p class='font-bold text-lg'>READ Permission Denied</p>
                        <p>Your role (${user.role}) is not authorized to retrieve content from the API (posts:read is missing).</p>
                    </div>
                `;
            } else if (isLoading) {
                 postsListHtml = `
                    <div class="flex justify-center items-center h-full min-h-[40vh] text-gray-800">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-t-4 border-indigo-500"></div>
                    </div>
                 `;
            } else if (generalMessage.startsWith('❌ Error')) {
                 postsListHtml = `
                    <div class="text-red-700 p-6 bg-red-100 rounded-xl border border-red-300 shadow-md dark:bg-red-900/50 dark:text-red-300 dark:border-red-700">
                        <p class='font-bold text-lg'>Access/Loading Error</p>
                        <p>Error: <strong>${generalMessage.substring(9)}</strong>. Check server status or confirm your role has permissions.</p>
                    </div>
                `;
            } else if (posts.length === 0) {
                postsListHtml = `<p class='text-gray-500 p-4 bg-white rounded-lg border border-gray-100 shadow-sm dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400'>No posts found.</p>`;
            } else {
                postsListHtml = `<div class="space-y-6">${posts.map(renderPostItem).join('')}</div>`;
            }

            const refreshButton = can('posts', 'read') ? `
                <button onclick="fetchPosts()" class="py-2 px-4 ml-4 bg-blue-500 text-white font-medium rounded-xl shadow-md hover:bg-blue-600 transition">
                    <span class='w-4 h-4 inline-block align-middle'>${ICONS.Refresh}</span> Refresh
                </button>
            ` : '';

            const contentHtml = `
                <div class="py-8 text-gray-800 dark:text-gray-200">
                    <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-8 flex items-center">
                        <span class='w-7 h-7 mr-3 text-blue-600 dark:text-blue-400'>${ICONS.Shield}</span> Content Dashboard
                    </h2>

                    ${renderPostForm()}

                    <div class="flex justify-between items-center border-b pb-2 border-gray-200 dark:border-gray-700 mb-5">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                            Available Posts (${posts.length})
                        </h3>
                        ${refreshButton}
                    </div>

                    ${postsListHtml}
                </div>
            `;
            document.getElementById('main-content').innerHTML = contentHtml;
        }

        // --- Admin Panel Logic ---

        let adminUsers = [];
        let adminMessage = '';
        let adminLoading = false;

        async function fetchUsers() {
            adminLoading = true;
            renderApp();
            adminMessage = '';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${user.token}` },
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to fetch users.');

                adminUsers = data;
            } catch (err) {
                adminMessage = `❌ Error fetching users: ${err.message}`;
                adminUsers = [];
            } finally {
                adminLoading = false;
                renderApp();
            }
        }

        async function handleRoleChange(userId, selectElement) {
            const newRole = selectElement.value;
            // Replaced confirm()
            if (!(true)) {
                // Reset select box if user cancels
                selectElement.value = adminUsers.find(u => u.id === userId)?.role || newRole;
                return;
            }

            selectElement.disabled = true;
            adminMessage = '';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${user.token}`
                    },
                    body: JSON.stringify({ newRole }),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Role update failed.');

                adminMessage = `✅ ${data.message}`;
                await fetchUsers(); // Re-fetch to update state
            } catch (err) {
                adminMessage = `❌ Error updating role: ${err.message}`;
                selectElement.disabled = false;
                renderApp();
            }
        }

        function renderAdminPanel() {
            let contentHtml;

            if (!can('users', 'read')) {
                contentHtml = `
                    <div class="text-red-700 p-8 mt-8 bg-red-100 rounded-xl shadow-lg border border-red-300 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700">
                        <h2 class='text-3xl font-bold flex items-center'>
                            <span class='w-6 h-6 mr-3'>${ICONS.Shield}</span> Unauthorized Access
                        </h2>
                        <p class='mt-3'>Your role (${user.role}) is not authorized to access user information in the Admin Panel.</p>
                    </div>
                `;
            } else if (adminLoading) {
                 contentHtml = `
                    <div class="flex justify-center items-center h-full min-h-[40vh] text-gray-800">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-t-4 border-indigo-500"></div>
                    </div>
                 `;
            } else {
                const canManageRoles = can('admin', 'manage_roles');

                const usersListHtml = adminUsers.map((u) => {
                    const selectHtml = canManageRoles && u.id !== user.userId ? `
                        <div class='flex items-center space-x-2'>
                            <select onchange="handleRoleChange('${u.id}', this)"
                                class="p-3 border border-gray-300 rounded-xl text-md font-medium bg-gray-50 shadow-sm text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                            >
                                <option value="ADMIN" ${u.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                                <option value="EDITOR" ${u.role === 'EDITOR' ? 'selected' : ''}>EDITOR</option>
                                <option value="VIEWER" ${u.role === 'VIEWER' ? 'selected' : ''}>VIEWER</option>
                            </select>
                            <span class="text-sm text-gray-500 italic dark:text-gray-400">Change Role</span>
                        </div>
                    ` : `
                        <span class="py-1 px-3 text-xs font-semibold rounded-full border ${u.id === user.userId ? 'bg-indigo-50 text-indigo-700 border-indigo-200 dark:bg-indigo-900/50 dark:text-indigo-300 dark:border-indigo-700' : 'bg-gray-200 text-gray-600 border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600'}">
                            ${u.id === user.userId ? 'You Are Here' : canManageRoles ? 'Access Denied by Auth Check' : 'No Permission'}
                        </span>
                    `;

                    return `
                        <div class="p-5 rounded-xl shadow flex justify-between items-center transition-shadow border ${u.id === user.userId ? 'bg-gray-100 border-gray-300 dark:bg-gray-700 dark:border-gray-600' : 'bg-white border-gray-200 hover:shadow-lg dark:bg-gray-800 dark:border-gray-700'}">
                            <div>
                                <p class="font-bold text-gray-900 text-lg dark:text-white">${u.username}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">ID: ${u.id} | Email: ${u.email}</p>
                                <span class="mt-1 inline-block px-3 py-1 text-xs font-semibold rounded-full border ${ROLE_COLORS[u.role]}">
                                    Current Role: ${u.role}
                                </span>
                            </div>
                            ${selectHtml}
                        </div>
                    `;
                }).join('');

                contentHtml = `
                    <div class="py-8 text-gray-800 dark:text-gray-200">
                        <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-8 flex items-center">
                            <span class='w-7 h-7 mr-3 text-blue-600 dark:text-blue-400'>${ICONS.Users}</span> User Management
                        </h2>

                        ${adminMessage ? `<div class="p-4 mb-6 rounded-xl text-sm font-medium ${adminMessage.startsWith('❌ Error') ? 'bg-red-50 text-red-700 border border-red-200 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700' : 'bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700'}">${adminMessage}</div>` : ''}

                        <div class="space-y-4">
                            ${usersListHtml}
                        </div>

                        ${!canManageRoles ? `
                            <div class='mt-6 p-4 bg-yellow-50 text-yellow-700 rounded-xl border border-yellow-300 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-700'>
                                <p class='font-bold'>Permission Detail:</p>
                                <p class='text-sm'>You can view users, but you are blocked from managing roles (\`admin:manage_roles\` is missing).</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            document.getElementById('main-content').innerHTML = contentHtml;
        }

        // --- Main App Flow ---

        function renderApp() {
            if (isLoading && !user) { // Only show full-page spinner if loading before login
                renderSpinner();
                return;
            }

            let mainContent = '';
            if (!user) {
                // If not logged in, always show the auth view
                mainContent = `<div id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16"></div>`;
                APP_ROOT.innerHTML = renderHeader() + mainContent;
                renderAuthView();
                return;
            }

            // Render main layout
            mainContent = `
                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
                    ${renderUserCard()}
                    <div id="main-content"></div>
                </main>
            `;
            APP_ROOT.innerHTML = renderHeader() + mainContent;

            // Render current view
            switch (currentView) {
                case 'admin':
                    renderAdminPanel();
                    break;
                case 'dashboard':
                default:
                    renderDashboard();
                    break;
            }
        }

        function setCurrentView(viewName, isRegister = false) {
            currentView = viewName;
            generalMessage = ''; // Clear general status on view change
            if (viewName === 'admin' && user && can('users', 'read') && !adminUsers.length) {
                fetchUsers();
            }
            if (viewName === 'dashboard' && user && can('posts', 'read') && !posts.length && !isLoading) {
                fetchPosts();
            }
            if (viewName === 'auth') {
                 // Special handling for auth view transition
                document.getElementById('main-content').innerHTML = ''; // Clear main content
                renderAuthView(isRegister);
                return;
            }
            renderApp();
        }

        // Make functions globally accessible for inline event handlers
        window.logout = logout;
        window.handleAuthSubmit = handleAuthSubmit;
        window.setCurrentView = setCurrentView;
        window.fetchPosts = fetchPosts;
        window.handlePostCreate = handlePostCreate;
        window.handlePostDelete = handlePostDelete;
        window.handleEditStart = handleEditStart;
        window.handlePostUpdate = handlePostUpdate;
        window.handleRoleChange = handleRoleChange;
        window.toggleTheme = toggleTheme; // Expose the new theme function

        // --- Initialization ---
        function initApp() {
            loadTheme(); // Load theme preference first
            loadUser();
            renderApp();
            // Start fetching data immediately if logged in and allowed
            if (user && can('posts', 'read') && currentView === 'dashboard') {
                fetchPosts();
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>